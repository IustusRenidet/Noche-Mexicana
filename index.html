const express = require('express');
const bodyParser = require('body-parser');
const app = express();
const port = 3000;

// Configuración de EJS como motor de plantillas
app.set('view engine', 'ejs');
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static('public'));

// Base de datos en memoria para gritos
let gritos = [
    { id: 1, texto: "¡Viva México!", votos: 10 },
    { id: 2, texto: "¡Vivan los héroes!", votos: 5 },
];

// Lista de cartas de Lotería Mexicana
const loteriaCards = [
    "El gallo", "El diablito", "La dama", "El catrín", "El paraguas", "La sirena", "La escalera", "La botella",
    "El barril", "El árbol", "El melón", "El valiente", "El gorrito", "La muerte", "La pera", "La bandera",
    "El bandolón", "El violoncello", "La garza", "El pájaro", "La mano", "La bota", "La luna", "El cotorro",
    "El borracho", "El negrito", "El corazón", "La sandía", "El tambor", "El camarón", "Las jaras", "El músico",
    "La araña", "El soldado", "La estrella", "El cazo", "El mundo", "El Apache", "El nopal", "El alacrán",
    "La rosa", "La calavera", "La campana", "El cantarito", "El venado", "El Sol", "La corona", "La chalupa",
    "El pino", "El pescado", "La palma", "La maceta", "El arpa", "La rana"
];

// Preguntas de trivia al estilo 100 Mexicanos Dijeron (con respuestas y puntos ficticios)
const triviaQuestions = [
    {
        question: "Menciona un animal que sea de color blanco.",
        answers: [
            { text: "Oso polar", points: 40 },
            { text: "Paloma blanca", points: 30 },
            { text: "Garza", points: 20 },
            { text: "Gaviota", points: 10 }
        ]
    },
    {
        question: "Comida que generalmente no le gusta a un niño.",
        answers: [
            { text: "Verduras", points: 45 },
            { text: "Pescado", points: 25 },
            { text: "Hígado", points: 20 },
            { text: "Frijoles", points: 10 }
        ]
    },
    {
        question: "Menciona además del plátano una fruta amarilla.",
        answers: [
            { text: "Manzana", points: 35 },
            { text: "Guayaba", points: 25 },
            { text: "Mango", points: 20 },
            { text: "Piña", points: 20 }
        ]
    },
    {
        question: "Antojitos mexicanos más populares.",
        answers: [
            { text: "Tacos", points: 50 },
            { text: "Pozole", points: 20 },
            { text: "Enchiladas", points: 15 },
            { text: "Quesadillas", points: 15 }
        ]
    },
    {
        question: "Parte del cuerpo donde los dolores son más frecuentes.",
        answers: [
            { text: "Cabeza", points: 40 },
            { text: "Estómago", points: 25 },
            { text: "Espalda", points: 20 },
            { text: "Piernas", points: 15 }
        ]
    }
    // Puedes agregar más preguntas si lo deseas
];

// Ruta principal: menú
app.get('/', (req, res) => {
    res.render('menu');
});

// Ruta para ranking de gritos
app.get('/gritos', (req, res) => {
    const ranking = gritos.sort((a, b) => b.votos - a.votos);
    res.render('gritos', { gritos: ranking });
});

app.post('/gritos/agregar', (req, res) => {
    const nuevoGrito = req.body.grito;
    if (nuevoGrito && nuevoGrito.trim() !== '') {
        const id = gritos.length > 0 ? Math.max(...gritos.map(g => g.id)) + 1 : 1;
        gritos.push({ id, texto: nuevoGrito, votos: 0 });
    }
    res.redirect('/gritos');
});

app.post('/gritos/votar/:id', (req, res) => {
    const id = parseInt(req.params.id);
    const grito = gritos.find(g => g.id === id);
    if (grito) {
        grito.votos += 1;
    }
    res.redirect('/gritos');
});

// Ruta para lotería
app.get('/loteria', (req, res) => {
    res.render('loteria', { cards: loteriaCards });
});

// Ruta para trivia
app.get('/trivia', (req, res) => {
    const randomQuestion = triviaQuestions[Math.floor(Math.random() * triviaQuestions.length)];
    res.render('trivia', { question: randomQuestion, guess: null, points: 0, revealed: false });
});

app.post('/trivia/guess', (req, res) => {
    const questionIndex = parseInt(req.body.questionIndex);
    const guess = req.body.guess.toLowerCase().trim();
    const question = triviaQuestions[questionIndex];
    let points = 0;
    let revealed = false;

    const matchingAnswer = question.answers.find(ans => ans.text.toLowerCase() === guess);
    if (matchingAnswer) {
        points = matchingAnswer.points;
    } else {
        revealed = true; // Revelar todas si falla
    }

    res.render('trivia', { question, guess, points, revealed });
});

// Iniciar el servidor
app.listen(port, () => {
    console.log(`Servidor corriendo en http://localhost:${port}`);
});